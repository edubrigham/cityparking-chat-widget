class CityparkingChatWidget extends HTMLElement{constructor(e={}){super(),this.attachShadow({mode:"open"}),this.noAnswerCount=0,this.isCollectingUserInfo=!1,this.isGeneratingResponse=!1,this.conversationHistory=[],this.config={webhookUrl:e.webhookUrl||e.chatUrl||null,language:e.language||document.documentElement.lang?.toLowerCase()||"en",theme:{primaryColor:e.theme?.primaryColor||"#009648",position:e.theme?.position||"bottom-right",...e.theme}},this.sessionToken=this.generateSessionToken(),this.messages={welcome:{en:"Welcome! I am Cue, your digital assistant powered by AI! üëã\nI'm here to help you with parking questions in Doornik.\n\nYou can ask questions about:\n‚Ä¢ Parking zones\n‚Ä¢ Resident permits\n‚Ä¢ Parking fees\n‚Ä¢ Special permits",nl:"Welkom! Ik ben Cue, uw digitale assistent gemaakt door AI! üëã\nIk ben hier om je te helpen met vragen over parkeren in Doornik.\n\nJe kunt vragen stellen over:\n‚Ä¢ Parkeerzones\n‚Ä¢ Residentenpermissies\n‚Ä¢ Parkeergeld\n‚Ä¢ Speciale permissies",fr:"Bienvenue! Je suis Cue, votre assistant digitale aliment√© par l'IA! üëã\nJe suis l√† pour vous aider avec vos questions sur le stationnement √† Tournai.\n\nVous pouvez poser des questions sur:\n‚Ä¢ Zones de stationnement\n‚Ä¢ Permis de r√©sident\n‚Ä¢ Frais de stationnement\n‚Ä¢ Permis sp√©ciaux"},confirmation:{question:{en:"Would you like Cityparking to handle your question?",nl:"Wilt u dat Cityparking uw vraag behandelt?",fr:"Souhaitez-vous que Cityparking traite votre question?"},buttons:{yes:{en:"Yes, please",nl:"Ja, graag",fr:"Oui, s'il vous pla√Æt"},no:{en:"No, thanks",nl:"Nee, bedankt",fr:"Non, merci"}},decline:{en:"No problem! Feel free to ask another question.",nl:"Geen probleem! Stel gerust een andere vraag.",fr:"Pas de probl√®me ! N'h√©sitez pas √† poser une autre question."}},errors:{general:{en:"Sorry, I encountered an error. Please try again.",nl:"Sorry, er is een fout opgetreden. Probeer het opnieuw.",fr:"D√©sol√©, j'ai rencontr√© une erreur. Veuillez r√©essayer."},submitInfo:{en:"Sorry, I encountered an error submitting your information.",nl:"Sorry, er is een fout opgetreden bij het versturen van uw gegevens.",fr:"D√©sol√©, j'ai rencontr√© une erreur lors de l'envoi de vos informations."}},userInfo:{formTitle:{en:"Contact Support",nl:"Contacteer Support",fr:"Contacter le Support"},firstName:{en:"First Name",nl:"Voornaam",fr:"Pr√©nom"},lastName:{en:"Last Name",nl:"Achternaam",fr:"Nom de famille"},email:{en:"Email Address",nl:"E-mailadres",fr:"Adresse e-mail"},phone:{en:"Phone Number",nl:"Telefoonnummer",fr:"Num√©ro de t√©l√©phone"},question:{en:"Your Question",nl:"Jouw vraag",fr:"Votre question"},submitButton:{en:"Submit",nl:"Verzenden",fr:"Soumettre"},submitting:{en:"Submitting...",nl:"Verzenden...",fr:"Envoi en cours..."},validation:{required:{en:"Please fill out all required fields.",nl:"Vul alstublieft alle verplichte velden in.",fr:"Veuillez remplir tous les champs obligatoires."},email:{en:"Please enter a valid email address (e.g., name@example.com)",nl:"Voer een geldig e-mailadres in (bijv. naam@voorbeeld.com)",fr:"Veuillez entrer une adresse e-mail valide (ex: nom@exemple.com)"},phone:{en:"Please enter a valid Belgian phone number (mobile: 0470123456 or landline: 021234567)",nl:"Voer een geldig Belgisch telefoonnummer in (mobiel: 0470123456 of vast: 021234567)",fr:"Veuillez entrer un num√©ro de t√©l√©phone belge valide (mobile: 0470123456 ou fixe: 021234567)"}},success:{en:"Thank you! Your information has been sent to our support team.",nl:"Bedankt! Uw informatie is verzonden naar ons supportteam.",fr:"Merci ! Vos informations ont √©t√© envoy√©es √† notre √©quipe de support."},placeholders:{firstName:{en:"Enter your first name",nl:"Voer uw voornaam in",fr:"Entrez votre pr√©nom"},lastName:{en:"Enter your last name",nl:"Voer uw achternaam in",fr:"Entrez votre nom de famille"},email:{en:"e.g., name@example.com",nl:"bijv. naam@voorbeeld.com",fr:"ex: nom@exemple.com"},phone:{en:"e.g., 0470123456 or 02123456   ",nl:"bijv. 0470123456 of 02123456",fr:"ex: 0470123456 ou 02123456"},question:{en:"Describe your parking question or issue...",nl:"Beschrijf uw parkeervraag of probleem...",fr:"D√©crivez votre question ou probl√®me de stationnement..."}}},placeholder:{en:"What are you looking for?",nl:"Waar ben je naar op zoek?",fr:"Que recherchez-vous?"},sourceButton:{en:"Source",nl:"Bron",fr:"Source"}},this.createWidget(),this.initialize(),this.conversationLanguage=this.config.language}generateSessionToken(){return"widget_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}createWidget(){const e=this.config.theme.position.includes("left"),n=`\n            :host {\n                --widget-height: 600px;\n                --widget-width: 350px;\n                --primary-color: ${this.config.theme.primaryColor};\n                --secondary-color: #f8f9fa;\n                --header-color: ${this.config.theme.primaryColor};\n                font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;\n            }\n            \n            .chat-widget {\n                position: fixed;\n                bottom: 20px;\n                ${e?"left":"right"}: 20px;\n                z-index: 1000;\n            }\n            \n            .chat-button {\n                width: 60px;\n                height: 60px;\n                border-radius: 50%;\n                background: var(--primary-color);\n                border: none;\n                cursor: pointer;\n                position: fixed;\n                bottom: 20px;\n                ${e?"left":"right"}: 20px;\n                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);\n                transition: transform 0.2s;\n                color: white;\n                font-size: 24px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n            }\n            \n            .chat-button:hover {\n                transform: scale(1.1);\n            }\n            \n            .chat-container {\n                position: fixed;\n                bottom: 90px;\n                ${e?"left":"right"}: 20px;\n                width: var(--widget-width);\n                height: var(--widget-height);\n                background: white;\n                border-radius: 15px;\n                box-shadow: 0 5px 20px rgba(0,0,0,0.15);\n                display: none;\n                flex-direction: column;\n                overflow: hidden;\n            }\n            \n            .chat-container.active {\n                display: flex;\n            }\n            \n            .chat-header {\n                background: var(--primary-color);\n                color: white;\n                padding: 20px;\n                font-weight: normal;\n                font-size: 16px;\n                display: flex;\n                align-items: center;\n                justify-content: space-between;\n                position: relative;\n            }\n            \n            .close-button {\n                background: none;\n                border: none;\n                color: white;\n                font-size: 20px;\n                cursor: pointer;\n                padding: 0;\n                line-height: 1;\n            }\n            \n            .close-button:hover {\n                opacity: 0.8;\n            }\n            \n            .chat-messages {\n                flex-grow: 1;\n                padding: 20px;\n                overflow-y: auto;\n                display: flex;\n                flex-direction: column;\n                gap: 16px;\n                background: #f8fafc;\n            }\n            \n            .message {\n                max-width: 85%;\n                padding: 12px 16px;\n                border-radius: 20px;\n                margin: 2px 0;\n                font-size: 14px;\n                line-height: 1.4;\n                font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;\n            }\n            \n            .user-message {\n                background: #1e293b;\n                color: white;\n                align-self: flex-end;\n                border-radius: 16px;\n                padding: 12px 16px;\n                font-size: 14px;\n                line-height: 1.5;\n                max-width: 80%;\n            }\n            \n            .bot-message-container {\n                display: flex;\n                justify-content: flex-start;\n                max-width: 80%;\n                align-self: flex-start;\n            }\n            \n            .bot-message {\n                background: white;\n                color: #1e293b;\n                border: 1px solid #e2e8f0;\n                border-radius: 16px;\n                margin: 0;\n                line-height: 1.5;\n                white-space: pre-wrap;\n                padding: 16px;\n                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);\n                width: 100%;\n            }\n            \n            .bot-header {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                margin-bottom: 8px;\n            }\n            \n            .bot-avatar {\n                width: 20px;\n                height: 20px;\n                border-radius: 50%;\n                background: var(--primary-color);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                color: white;\n                font-weight: bold;\n                font-size: 11px;\n                flex-shrink: 0;\n            }\n            \n            .bot-label {\n                font-size: 12px;\n                font-weight: 600;\n                color: #64748b;\n            }\n            \n            .bot-message-text {\n                font-size: 14px;\n                line-height: 1.5;\n                color: #1e293b;\n            }\n            \n            .chat-input {\n                display: flex;\n                padding: 15px;\n                background: white;\n                border-top: 1px solid #eee;\n            }\n            \n            .chat-input input {\n                flex-grow: 1;\n                padding: 12px;\n                border: 1px solid #eee;\n                border-radius: 25px;\n                margin-right: 10px;\n                font-size: 14px;\n                font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;\n            }\n            \n            .chat-input input:focus {\n                outline: none;\n                border-color: var(--primary-color);\n            }\n            \n            .chat-input input:disabled {\n                background-color: #f5f5f5;\n                cursor: not-allowed;\n            }\n            \n            .chat-input button {\n                width: 40px;\n                height: 40px;\n                background: var(--primary-color);\n                color: white;\n                border: none;\n                border-radius: 50%;\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 20px;\n            }\n            \n            .chat-input button:disabled {\n                opacity: 0.5;\n                cursor: not-allowed;\n            }\n            \n            .sources {\n                font-size: 0.8em;\n                margin-top: 8px;\n                display: flex;\n                gap: 8px;\n            }\n            \n            .source-button {\n                padding: 6px 12px;\n                background: white;\n                color: var(--primary-color);\n                border: 1px solid var(--primary-color);\n                border-radius: 15px;\n                cursor: pointer;\n                font-size: 12px;\n                transition: all 0.2s;\n            }\n            \n            .source-button:hover {\n                background: var(--primary-color);\n                color: white;\n            }\n            \n            .action-buttons {\n                display: flex;\n                gap: 10px;\n                margin-top: 10px;\n            }\n            \n            .action-button {\n                padding: 6px 12px;\n                border-radius: 16px;\n                cursor: pointer;\n                font-size: 12px;\n                border: 1px solid var(--primary-color);\n                transition: all 0.2s;\n            }\n            \n            .action-button.primary {\n                background: white;\n                color: var(--primary-color);\n            }\n            \n            .action-button.secondary {\n                background: white;\n                color: var(--primary-color);\n            }\n            \n            .action-button:hover {\n                opacity: 0.9;\n            }\n            \n            .typing-indicator {\n                display: flex;\n                gap: 4px;\n                padding: 8px 12px;\n                background: #f0f0f0;\n                border-radius: 10px;\n                width: fit-content;\n            }\n            \n            .typing-dot {\n                width: 6px;\n                height: 6px;\n                background: var(--primary-color);\n                border-radius: 50%;\n                opacity: 0.3;\n                animation: typingAnimation 1.4s infinite;\n            }\n            \n            .typing-dot:nth-child(2) {\n                animation-delay: 0.2s;\n            }\n            \n            .typing-dot:nth-child(3) {\n                animation-delay: 0.4s;\n            }\n            \n            @keyframes typingAnimation {\n                0%, 100% { opacity: 0.3; transform: scale(1); }\n                50% { opacity: 1; transform: scale(1.2); }\n            }\n            \n            .powered-by {\n                text-align: center;\n                padding: 8px;\n                font-size: 12px;\n                color: #666;\n                border-top: 1px solid #eee;\n            }\n            \n            .powered-by a {\n                color: var(--primary-color);\n                text-decoration: none;\n            }\n            \n            .powered-by a:hover {\n                text-decoration: underline;\n            }\n\n            .user-info-form-container {\n                flex-grow: 1;\n                padding: 20px;\n                overflow-y: auto;\n                background: white;\n                display: none;\n            }\n\n            .user-info-form h3 {\n                margin-top: 0;\n                font-size: 16px;\n                text-align: center;\n                color: #333;\n            }\n\n            .form-field {\n                margin-bottom: 10px;\n            }\n\n            .form-field label {\n                display: block;\n                margin-bottom: 5px;\n                font-size: 14px;\n                color: #555;\n            }\n\n            .form-field input,\n            .form-field textarea {\n                width: 100%;\n                padding: 8px;\n                font-size: 12px;\n                border: 1px solid #ddd;\n                border-radius: 8px;\n                box-sizing: border-box;\n            }\n\n            .form-field input::placeholder,\n            .form-field textarea::placeholder {\n                color: #999;\n                opacity: 1;\n            }\n\n            .form-field input.error,\n            .form-field textarea.error {\n                border-color: #e74c3c;\n                background-color: #fdf2f2;\n            }\n\n            .form-field input.error:focus,\n            .form-field textarea.error:focus {\n                border-color: #e74c3c;\n                box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.2);\n            }\n\n            .field-error {\n                color: #e74c3c;\n                font-size: 11px;\n                margin-top: 3px;\n                display: block;\n            }\n\n            .form-field textarea {\n                resize: vertical;\n                min-height: 100px;\n            }\n\n            .form-submit-button {\n                width: 100%;\n                padding: 12px;\n                background-color: var(--primary-color);\n                color: white;\n                border: none;\n                border-radius: 8px;\n                cursor: pointer;\n                font-size: 16px;\n                margin-top: 10px;\n                transition: background-color 0.2s;\n            }\n\n            .form-submit-button:disabled {\n                background-color: #ccc;\n                cursor: not-allowed;\n            }\n\n            .form-submit-button:hover:not(:disabled) {\n                opacity: 0.9;\n            }\n        `;this.shadowRoot.innerHTML=`\n            <style>${n}</style>\n            <div class="chat-widget">\n                <button class="chat-button">üí¨</button>\n                <div class="chat-container">\n                    <div class="chat-header">\n                        <span>Cityparking Assistant</span>\n                        <button class="close-button">√ó</button>\n                    </div>\n                    <div class="chat-messages"></div>\n                    <div class="user-info-form-container"></div>\n                    <div class="chat-input">\n                        <input type="text" placeholder="${this.messages.placeholder[this.config.language]||this.messages.placeholder.en}">\n                        <button>‚û§</button>\n                    </div>\n                    <div class="powered-by">\n                        Powered by <a href="https://www.ringring.be" target="_blank">RingRing</a>\n                    </div>\n                </div>\n            </div>\n        `}initialize(){const e=this.shadowRoot.querySelector(".chat-button"),n=this.shadowRoot.querySelector(".chat-container"),t=this.shadowRoot.querySelector(".close-button"),s=this.shadowRoot.querySelector("input"),o=this.shadowRoot.querySelector(".chat-input button"),i=(this.shadowRoot.querySelector(".chat-messages"),this.messages.welcome[this.config.language]||this.messages.welcome.en);this.addMessage(i,"bot",[],!0),e.addEventListener("click",()=>{n.classList.contains("active")?n.classList.remove("active"):(n.classList.add("active"),s.focus())}),t.addEventListener("click",()=>{n.classList.remove("active"),this.resetWidgetState()}),o.addEventListener("click",()=>this.sendMessage()),s.addEventListener("keypress",e=>{"Enter"===e.key&&this.sendMessage()})}setInputState(e){const n=this.shadowRoot.querySelector(".chat-input input"),t=this.shadowRoot.querySelector(".chat-input button");n.disabled=!e,t.disabled=!e,e&&n.focus()}resetWidgetState(){this.sessionToken=this.generateSessionToken(),this.conversationLanguage=this.config.language,this.conversationHistory&&(this.conversationHistory=[]),this.isGeneratingResponse=!1;this.shadowRoot.querySelector(".chat-messages").innerHTML="",this.hideUserInfoForm();this.shadowRoot.querySelector(".chat-input input").value="",this.setInputState(!0);const e=this.messages.welcome[this.config.language]||this.messages.welcome.en;this.addMessage(e,"bot",[],!0),console.log("Widget state reset. New session:",this.sessionToken)}sendActionMessage(e,n=null,t=null){const s=n||e;this.addMessage(s,"user"),"handover_request_yes"!==e?(this.setInputState(!1),this.isGeneratingResponse=!0,this.sendMessageToWebhook(e,t)):this.showUserInfoForm()}async sendMessageToWebhook(e,n=null){try{const t={chatInput:e,sessionId:this.sessionToken,pageUrl:window.location.href,pageTitle:document.title,referrer:document.referrer||null};n&&(t.language=n);const s=await fetch(this.config.webhookUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),o=await s.json();o.response&&(this.addMessage(o.response,"bot"),"handover_request_yes"===e&&this.showUserInfoForm())}catch(e){console.error("Error sending action message:",e),this.addMessage(this.messages.errors.general[this.config.language]||this.messages.errors.general.en,"bot")}finally{this.isGeneratingResponse=!1,this.setInputState(!0)}}async sendMessage(){const e=this.shadowRoot.querySelector("input"),n=e.value.trim();if(n&&!this.isGeneratingResponse&&!this.isCollectingUserInfo){this.isGeneratingResponse=!0,this.setInputState(!1),this.addMessage(n,"user"),e.value="";try{const e=document.createElement("div");e.classList.add("bot-message-container");const t=document.createElement("div");t.classList.add("typing-indicator");for(let e=0;e<3;e++){const e=document.createElement("div");e.classList.add("typing-dot"),t.appendChild(e)}const s=document.createElement("div");s.classList.add("bot-message"),s.style.display="none";const o=document.createElement("div");o.classList.add("bot-header");const i=document.createElement("div");i.classList.add("bot-avatar"),i.textContent="C";const r=document.createElement("span");r.classList.add("bot-label"),r.textContent="Assistant",o.appendChild(i),o.appendChild(r);const a=document.createElement("div");a.classList.add("bot-message-text"),s.appendChild(o),s.appendChild(a),e.appendChild(t),e.appendChild(s);const l=this.shadowRoot.querySelector(".chat-messages");l.appendChild(e);const d=await fetch(this.config.webhookUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chatInput:n,sessionId:this.sessionToken})}),c=d.headers.get("content-type")||"";if(!(c.includes("text/plain")||c.includes("text/event-stream"))){const e=await d.json();if(t.remove(),s.style.display="block",e.response){let n=e.response.replace(/\*\*/g,"");if(a.textContent=n,e.sessionData&&e.sessionData.language?this.conversationLanguage=e.sessionData.language:e.language&&(this.conversationLanguage=e.language),e.actions&&e.actions.length>0){const n=document.createElement("div");n.classList.add("action-buttons");const t=e.language||this.conversationLanguage;e.actions.forEach(e=>{const s=document.createElement("button");s.textContent=e.text||"Action","url"===e.type?(s.classList.add("source-button"),s.addEventListener("click",()=>{window.open(e.payload,"_blank")})):"message"===e.type&&(s.classList.add("action-button","primary"),s.addEventListener("click",()=>{this.sendActionMessage(e.payload,e.text,t)})),n.appendChild(s)}),s.appendChild(n)}else if(e.sources&&e.sources.length>0){const n=document.createElement("div");n.classList.add("sources");const t=e.sources.slice(0,2),o=this.messages.sourceButton[this.config.language]||this.messages.sourceButton.en;t.forEach((e,t)=>{const s=document.createElement("button");s.classList.add("source-button"),s.textContent=`${o} ${t+1}`,s.addEventListener("click",()=>{window.open(e,"_blank")}),n.appendChild(s)}),s.appendChild(n)}}else if(e.content){let n=e.content.replace(/\*\*/g,"");a.textContent=n}else a.textContent=JSON.stringify(e);return void(l.scrollTop=l.scrollHeight)}const u=d.body.getReader(),h=new TextDecoder;let m=!1,p=!0;for(;;){const{value:e,done:n}=await u.read();if(n)break;const o=h.decode(e).split("\n").filter(e=>e.trim());for(const e of o)try{const n=JSON.parse(e);switch(p&&(t.remove(),s.style.display="block",p=!1),n.type){case"token":let e=n.content.replace(/\*\*/g,"");e.includes("‚Ä¢")&&(e=`<br>‚Ä¢ ${e.replace("‚Ä¢","")}`),e.includes("\n")&&(e=e.replace(/\n/g,"<br>")),/[.!?]/.test(e)&&(e+=" "),a.innerHTML+=e,this.scrollToBottom();break;case"rephrase":this.noAnswerCount++,s.textContent=n.content,this.scrollToBottom();break;case"needsUserInfo":if(n.content){s.textContent=this.messages.confirmation.question[this.config.language]||this.messages.confirmation.question.en;await this.handleConfirmation(s)?m=!0:this.noAnswerCount=0}else this.noAnswerCount=0;break;case"showForm":p&&(t.remove(),s.style.display="none",p=!1),this.showUserInfoForm();break;case"sources":if(n.content&&n.content.length>0){const e=document.createElement("div");e.classList.add("sources");const t=n.content.slice(0,2),o=this.messages.sourceButton[this.config.language]||this.messages.sourceButton.en;t.forEach((n,t)=>{const s=document.createElement("button");s.classList.add("source-button"),s.textContent=`${o} ${t+1}`,s.addEventListener("click",()=>{window.open(n,"_blank")}),e.appendChild(s)}),s.appendChild(e),this.scrollToBottom()}break;case"error":s.textContent=this.messages.errors.general[this.config.language]||this.messages.errors.general.en,this.scrollToBottom()}}catch(e){console.error("Error parsing response:",e)}}m&&(this.showUserInfoForm(),this.noAnswerCount=0)}catch(e){console.error("Error:",e),this.addMessage(this.messages.errors.general[this.config.language]||this.messages.errors.general.en,"bot")}finally{this.isGeneratingResponse=!1,this.setInputState(!0)}}}validateEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}validateBelgianPhone(e){const n=e.replace(/[\s.\-\/\(\)]/g,"");return/^(\+32(455|456|465|466|467|468|47\d|48\d|49\d)\d{6}|0(455|456|465|466|467|468|47\d|48\d|49\d)\d{6})$/.test(n)||/^(\+32[23579]\d{7,8}|0[23579]\d{7,8}|\+321[0-6]\d{6,7}|01[0-6]\d{6,7}|\+325[0-9]\d{6,7}|05[0-9]\d{6,7}|\+326[0-9]\d{6,7}|06[0-9]\d{6,7}|\+3271\d{6}|071\d{6}|\+328[0-7,9]\d{6,7}|08[0-7,9]\d{6,7})$/.test(n)}showFieldError(e,n){const t=this.shadowRoot.querySelector(`#${e}`),s=t.closest(".form-field");t.classList.add("error");const o=s.querySelector(".field-error");o&&o.remove();const i=document.createElement("div");i.className="field-error",i.textContent=n,s.appendChild(i);const r=()=>{t.classList.remove("error"),i.remove(),t.removeEventListener("input",r)};t.addEventListener("input",r)}clearFieldErrors(){const e=this.shadowRoot.querySelector(".user-info-form"),n=e.querySelectorAll("input.error, textarea.error"),t=e.querySelectorAll(".field-error");n.forEach(e=>e.classList.remove("error")),t.forEach(e=>e.remove())}showUserInfoForm(){const e=this.shadowRoot.querySelector(".user-info-form-container"),n=this.shadowRoot.querySelector(".chat-messages"),t=this.shadowRoot.querySelector(".chat-input"),s=this.conversationLanguage||this.config.language,o=`\n            <div class="user-info-form">\n                <h3>${this.messages.userInfo.formTitle[s]||this.messages.userInfo.formTitle.en}</h3>\n                <div class="form-field">\n                    <label for="firstName">${this.messages.userInfo.firstName[s]||this.messages.userInfo.firstName.en}</label>\n                    <input type="text" id="firstName" name="firstName" required placeholder="${this.messages.userInfo.placeholders.firstName[s]||this.messages.userInfo.placeholders.firstName.en}">\n                </div>\n                <div class="form-field">\n                    <label for="lastName">${this.messages.userInfo.lastName[s]||this.messages.userInfo.lastName.en}</label>\n                    <input type="text" id="lastName" name="lastName" required placeholder="${this.messages.userInfo.placeholders.lastName[s]||this.messages.userInfo.placeholders.lastName.en}">\n                </div>\n                <div class="form-field">\n                    <label for="email">${this.messages.userInfo.email[s]||this.messages.userInfo.email.en}</label>\n                    <input type="email" id="email" name="email" required placeholder="${this.messages.userInfo.placeholders.email[s]||this.messages.userInfo.placeholders.email.en}">\n                </div>\n                <div class="form-field">\n                    <label for="phone">${this.messages.userInfo.phone[s]||this.messages.userInfo.phone.en}</label>\n                    <input type="tel" id="phone" name="phone" required placeholder="${this.messages.userInfo.placeholders.phone[s]||this.messages.userInfo.placeholders.phone.en}">\n                </div>\n                <div class="form-field">\n                    <label for="question">${this.messages.userInfo.question[s]||this.messages.userInfo.question.en}</label>\n                    <textarea id="question" name="question" required placeholder="${this.messages.userInfo.placeholders.question[s]||this.messages.userInfo.placeholders.question.en}"></textarea>\n                </div>\n                <button class="form-submit-button">${this.messages.userInfo.submitButton[s]||this.messages.userInfo.submitButton.en}</button>\n            </div>\n        `;e.innerHTML=o,n.style.display="none",t.style.display="none",e.style.display="block";e.querySelector(".form-submit-button").addEventListener("click",()=>this.handleFormSubmit())}hideUserInfoForm(){const e=this.shadowRoot.querySelector(".user-info-form-container"),n=this.shadowRoot.querySelector(".chat-messages"),t=this.shadowRoot.querySelector(".chat-input");e.innerHTML="",e.style.display="none",n.style.display="flex",t.style.display="flex"}async handleFormSubmit(){const e=this.shadowRoot.querySelector(".user-info-form"),n=e.querySelector(".form-submit-button"),t=e.querySelector("#firstName"),s=e.querySelector("#lastName"),o=e.querySelector("#email"),i=e.querySelector("#phone"),r=e.querySelector("#question"),a=t.value.trim(),l=s.value.trim(),d=o.value.trim(),c=i.value.trim(),u=r.value.trim(),h=this.conversationLanguage||this.config.language;this.clearFieldErrors();let m=!1;if(a||(this.showFieldError("firstName",this.messages.userInfo.validation.required[h]||this.messages.userInfo.validation.required.en),m=!0),l||(this.showFieldError("lastName",this.messages.userInfo.validation.required[h]||this.messages.userInfo.validation.required.en),m=!0),u||(this.showFieldError("question",this.messages.userInfo.validation.required[h]||this.messages.userInfo.validation.required.en),m=!0),d&&!this.validateEmail(d)?(this.showFieldError("email",this.messages.userInfo.validation.email[h]||this.messages.userInfo.validation.email.en),m=!0):d||(this.showFieldError("email",this.messages.userInfo.validation.required[h]||this.messages.userInfo.validation.required.en),m=!0),c&&!this.validateBelgianPhone(c)?(this.showFieldError("phone",this.messages.userInfo.validation.phone[h]||this.messages.userInfo.validation.phone.en),m=!0):c||(this.showFieldError("phone",this.messages.userInfo.validation.required[h]||this.messages.userInfo.validation.required.en),m=!0),m)return;const p={firstName:a,lastName:l,email:d,phone:c,question:u,language:this.conversationLanguage||this.config.language,conversation:this.conversationHistory};n.disabled=!0,n.textContent=this.messages.userInfo.submitting[h]||this.messages.userInfo.submitting.en;try{const e=await this.submitUserInfo(p);this.hideUserInfoForm();const n=this.messages.userInfo.success[h]||this.messages.userInfo.success.en;this.addMessage(e.message||e.response||n,"bot")}catch(e){this.addMessage(this.messages.errors.submitInfo[h]||this.messages.errors.submitInfo.en,"bot")}finally{this.setInputState(!0)}}async submitUserInfo(e){try{const n=await fetch(this.config.webhookUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chatInput:"handover_form_submission",sessionId:this.sessionToken,pageUrl:window.location.href,pageTitle:document.title,referrer:document.referrer||null,handover_info:{firstName:e.firstName,lastName:e.lastName,email:e.email,phone:e.phone,question:e.question},formData:e,bypass_conversational:!0,form_complete:!0})});if(!n.ok)throw new Error("Failed to submit user info");return await n.json()}catch(e){throw console.error("Error submitting user info:",e),e}}addMessage(e,n,t=[],s=!1){this.conversationHistory.push({type:n,text:e.replace(/<[^>]*>/g,""),timestamp:(new Date).toISOString()});const o=this.shadowRoot.querySelector(".chat-messages");if("bot"===n){const n=document.createElement("div");n.classList.add("bot-message-container");const i=document.createElement("div");i.classList.add("bot-message"),s&&i.classList.add("welcome-message");const r=document.createElement("div");r.classList.add("bot-header");const a=document.createElement("div");a.classList.add("bot-avatar"),a.textContent="C";const l=document.createElement("span");l.classList.add("bot-label"),l.textContent="Assistant",r.appendChild(a),r.appendChild(l);const d=document.createElement("div");if(d.classList.add("bot-message-text"),d.innerHTML=e,i.appendChild(r),i.appendChild(d),t&&t.length>0){const e=document.createElement("div");e.classList.add("sources"),e.innerHTML="Sources:<br>"+t.map(e=>`- ${e}`).join("<br>"),i.appendChild(e)}n.appendChild(i),o.appendChild(n)}else{const n=document.createElement("div");n.classList.add("message","user-message"),n.textContent=e,o.appendChild(n)}this.scrollToBottom()}scrollToBottom(e=!0){setTimeout(()=>{requestAnimationFrame(()=>{const n=this.shadowRoot.querySelector(".chat-messages"),t=e?{behavior:"smooth"}:{behavior:"auto"};n.scrollTo({top:n.scrollHeight+100,behavior:t.behavior})})},100)}async handleConfirmation(e){return this.setInputState(!1),new Promise(n=>{const t=document.createElement("div");t.classList.add("action-buttons");const s=document.createElement("button");s.classList.add("action-button","primary"),s.textContent=this.messages.confirmation.buttons.yes[this.config.language]||this.messages.confirmation.buttons.yes.en;const o=document.createElement("button");o.classList.add("action-button","secondary"),o.textContent=this.messages.confirmation.buttons.no[this.config.language]||this.messages.confirmation.buttons.no.en,t.appendChild(s),t.appendChild(o),e.appendChild(t),s.addEventListener("click",()=>{t.remove(),this.showUserInfoForm(),n(!0)}),o.addEventListener("click",()=>{t.remove();const e=this.messages.confirmation.decline[this.config.language]||this.messages.confirmation.decline.en;this.addMessage(e,"bot"),this.setInputState(!0),n(!1)})})}}window.initCityparkingWidget=function(e={}){if(e.webhookUrl||e.chatUrl){if(!document.querySelector("cityparking-chat-widget")){customElements.define("cityparking-chat-widget",CityparkingChatWidget);const n=new CityparkingChatWidget(e);n.setAttribute("id","cityparking-chat-widget"),document.body.appendChild(n),console.log("CityParking Chat Widget initialized with config:",e)}}else console.error("CityparkingWidget: webhookUrl is required")},document.addEventListener("DOMContentLoaded",()=>{const e=document.currentScript||document.querySelector("script[data-webhook-url], script[data-chat-url]");e&&(e.dataset.webhookUrl||e.dataset.chatUrl)&&window.initCityparkingWidget({webhookUrl:e.dataset.webhookUrl||e.dataset.chatUrl,language:e.dataset.language||document.documentElement.lang,theme:{primaryColor:e.dataset.primaryColor||e.dataset.widgetBtnColor,position:e.dataset.position||e.dataset.btnPosition||"bottom-right"}})});